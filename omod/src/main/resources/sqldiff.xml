<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
        <help>
                USE:
                The diffs are ordered by datamodel version number.
                The script can be run in a top down fashion and is
                expected to not failor overwrite old data

                EXPECT:
                - "use business-database-name;" was called prior to
                calling this script
        </help>
        <diff>
                <version>1.0</version>
                <author>Apurv Mehra</author>
                <date>Jan 3rd 2013</date>
                <description>
                        Create tables for SDMX if they do not exist
                </description>
                <sql>


						CREATE TABLE IF NOT EXISTS `dhisreport_dataelement` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `de_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `code` (`code`),
						  UNIQUE KEY `uid` (`uid`)
						) ENGINE=InnoDB AUTO_INCREMENT=813 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_disaggregation` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `disagg_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `uid` (`uid`),
						  UNIQUE KEY `code` (`code`)
						) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_report_definition` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `report_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `code` (`code`),
						  UNIQUE KEY `uid` (`uid`)
						) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_datavalue_template` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `report_definition_id` int(11) NOT NULL,
						  `dataelement_id` int(11) NOT NULL,
						  `disaggregation_id` int(11) NOT NULL,
						  `query` text,
						  PRIMARY KEY (`id`),
						  KEY `fk_dataelement_datavaluetemplate` (`dataelement_id`),
						  KEY `fk_disaggregation_datavaluetemplate` (`disaggregation_id`),
						  KEY `fk_report_definition_datavaluetemplate` (`report_definition_id`),
						  CONSTRAINT `fk_dataelement_datavaluetemplate` FOREIGN KEY (`dataelement_id`) REFERENCES `dhisreport_dataelement` (`id`),
						  CONSTRAINT `fk_disaggregation_datavaluetemplate` FOREIGN KEY (`disaggregation_id`) REFERENCES `dhisreport_disaggregation` (`id`),
						  CONSTRAINT `fk_report_definition_datavaluetemplate` FOREIGN KEY (`report_definition_id`) REFERENCES `dhisreport_report_definition` (`id`)
						) ENGINE=InnoDB AUTO_INCREMENT=828 DEFAULT CHARSET=latin1;

                </sql>
        </diff>

        <diff>
			<version>1.1</version>
			<author>Apurv Mehra</author>
			<date>Feb 15th 2014</date>
			<description>
				Added 'period type' to report definition table
			</description>
			<sql>
				ALTER TABLE `dhisreport_report_definition`
 				ADD `periodType` varchar(16) DEFAULT NULL;
			</sql>
		</diff>
	<diff>
		<version>1.2</version>
		<author>Sri Maurya Kummamuru</author>
		<date>Mar 16th 2016</date>
		<description>
			Added 'reportingReportUuid' to report definition table
		</description>
		<sql>
			ALTER TABLE `dhisreport_report_definition`
			ADD `reportingreportuuid` char(38) DEFAULT NULL;
		</sql>
	</diff>

        <diff>
		<version>1.3</version>
		<author>Choxmi Sathsara</author>
		<date>June 26th 2017</date>
		<description>
			Added 'default_report_query' and 'mapped_definition_id' to datavalue_template table
		</description>
		<sql>
			ALTER TABLE `dhisreport_datavalue_template`
			ADD `defaultreportquery` text DEFAULT NULL,
                        ADD `mappeddefinitionlabel` text DEFAULT NULL,
                        ADD `mappeddefinitionuuid` text DEFAULT NULL;
		</sql>
	</diff>
	<diff>
		<version>2.1</version>
		<author>Jayasanka Weerasinghe</author>
		<date>July 9th 2020</date>
		<description>
			Update the current model to support ADX desegregations
		</description>
		<sql>
			DROP TABLE `dhisreport_datavalue_template`;
			DROP TABLE `dhisreport_disaggregation`;
			DROP TABLE `dhisreport_report_definition`;
			DROP TABLE `dhisreport_dataelement`;

			CREATE TABLE IF NOT EXISTS `dhisreport_dataset` (
			`dataset_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`name` VARCHAR(255) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			`period_type` VARCHAR(50) NOT NULL,
			`report_definition_uuid` VARCHAR(36) NULL,
			PRIMARY KEY (`dataset_id`))
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_data_element` (
			`data_element_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`name` VARCHAR(255) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			PRIMARY KEY (`data_element_id`))
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_dataset_data_element` (
			`dataset_id` INT NOT NULL,
			`data_element_id` INT NOT NULL,
			PRIMARY KEY (`dataset_id`, `data_element_id`),
			CONSTRAINT `fk_dataset_has_data_element_dataset`
			FOREIGN KEY (`dataset_id`)
			REFERENCES `dhisreport_dataset` (`dataset_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_dataset_has_data_element_data_element1`
			FOREIGN KEY (`data_element_id`)
			REFERENCES `dhisreport_data_element` (`data_element_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_data_value_template` (
			`data_value_template_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`dataset_id` INT NOT NULL,
			`data_element_id` INT NOT NULL,
			`report_indicator_label` VARCHAR(255) NULL,
			PRIMARY KEY (`data_value_template_id`),
			CONSTRAINT `fk_data_value_template_dataset1`
			FOREIGN KEY (`dataset_id`)
			REFERENCES `dhisreport_dataset` (`dataset_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_data_value_template_data_element1`
			FOREIGN KEY (`data_element_id`)
			REFERENCES `dhisreport_data_element` (`data_element_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_category` (
			`category_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			`name` VARCHAR(255) NOT NULL,
			PRIMARY KEY (`category_id`))
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_category_option` (
			`category_option_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			`name` VARCHAR(255) NULL,
			PRIMARY KEY (`category_option_id`))
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_disaggregation` (
			`disaggregation_id` INT NOT NULL AUTO_INCREMENT,
			`uuid` VARCHAR(36) NOT NULL,
			`category_id` INT NOT NULL,
			`category_option_id` INT NOT NULL,
			PRIMARY KEY (`disaggregation_id`),
			CONSTRAINT `fk_disaggregation_category1`
			FOREIGN KEY (`category_id`)
			REFERENCES `dhisreport_category` (`category_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_disaggregation_category_option1`
			FOREIGN KEY (`category_option_id`)
			REFERENCES `dhisreport_category_option` (`category_option_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_disaggregation_data_value_template` (
			`disaggregation_id` INT NOT NULL,
			`data_value_template_id` INT NOT NULL,
			PRIMARY KEY (`disaggregation_id`, `data_value_template_id`),
			CONSTRAINT `fk_dhisreport_disaggregation_has_dhisreport_data_value_templa1`
			FOREIGN KEY (`disaggregation_id`)
			REFERENCES `dhisreport_disaggregation` (`disaggregation_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_dhisreport_disaggregation_has_dhisreport_data_value_templa2`
			FOREIGN KEY (`data_value_template_id`)
			REFERENCES `dhisreport_data_value_template` (`data_value_template_id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;
		</sql>
	</diff>
</sqldiff>
